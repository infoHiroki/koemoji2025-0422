# 音声会議インテリジェンスシステム「koemoji2025」決済システム設計書

## 1. 決済プラットフォーム選定

### 1.1 Stripe採用の理由
- **信頼性と安全性**: PCI DSS準拠の堅牢なセキュリティ対策
- **柔軟性**: 多様な決済手段への将来的な拡張性
- **開発効率**: 整備されたAPI・SDK・ドキュメントによる迅速な実装
- **国際対応**: 将来的な海外展開も視野に入れたプラットフォーム選択

### 1.2 他の決済手段との比較
- **LINE Pay**: LINE連携の利点はあるが、ユーザー層が限定される
- **PayPal**: 国際決済に強いが、日本市場では普及率が低い
- **銀行振込**: 導入は容易だが、自動化が難しく運用コストが高い

## 2. 料金体系とStripeでの実装

### 2.1 サブスクリプションプラン設計
- **個人プラン**: 月額1,500円（3時間/月）
- **ビジネスプラン**: 月額4,000円（10時間/月）
- Stripeの「Subscription」機能を使用して実装
- 毎月自動更新の仕組みを標準で提供

### 2.2 従量課金（超過分）の処理
- サブスクリプション時間を超える利用: 8円/分
- 月末に使用量を集計し、Stripeの「Invoice Items」として追加
- 次回定期請求時に合算して決済処理

### 2.3 大容量ファイル追加料金
- 500MB超のファイル: 10%の追加料金
- 通常料金計算後に追加料金を自動計算
- Stripeの「Tax Rate」機能で実装可能

## 3. ユーザー認証と決済連携

### 3.1 認証システム設計
- **LINE認証の活用**
  - LINE LIFFアプリのログイン機能を使用
  - LINEユーザーIDを主キーとしたユーザー管理
  - LINEプロフィール情報（表示名、アイコン）の取得と利用

- **認証フロー**
  - LINE LIFFアプリ起動時に自動認証
  - 初回ログイン時にユーザーレコード作成
  - 再ログイン時にセッション再開

- **セッション管理**
  - JWTベースのセッショントークン発行
  - LINE認証情報とセッション紐付け
  - セキュアなCookieでのトークン管理

### 3.2 Stripeとの連携
- **ユーザーID連携**
  - LINE IDをStripeのcustomer.metadataに保存
  - 内部DB上でStripe顧客IDとLINE IDのマッピング
  - 複数端末からのアクセスでも同一ユーザー識別

- **決済情報管理**
  - クレジットカード情報はStripe側で保管
  - 決済履歴とLINEユーザーの紐付け
  - サブスクリプション状態のリアルタイム反映

- **認証・決済連携フロー**
  1. ユーザーがLINE LIFFアプリにアクセス
  2. LINE認証を通じてユーザー特定
  3. 初回利用時はStripe Customer作成
  4. 既存ユーザーは保存済みの決済情報を参照
  5. サブスクリプション状態に応じた機能提供

### 3.3 マルチデバイス対応
- LINE認証によるデバイス間の一貫性確保
- 異なるデバイスでもLINE IDによる同一ユーザー認識
- サブスクリプション状態の全デバイスでの同期

## 4. システム実装計画

### 4.1 初期実装（MVP）
- クレジットカード決済のみでスタート
- サブスクリプション基本機能の実装
- 利用履歴・請求履歴の表示機能

### 4.2 データモデル設計
```
# Userモデルとの連携
- line_user_id: LINE固有識別子
- line_display_name: LINEプロフィール名
- line_picture_url: LINEプロフィール画像URL
- stripe_customer_id: Stripeカスタマー参照ID
- subscription_status: サブスクリプション状態
- subscription_plan: 契約プラン種別
- subscription_start: 開始日
- next_billing_date: 次回請求日

# 利用記録
- 音声処理時間の記録と集計機能
- 月次利用サマリーの自動生成
```

### 4.3 段階的拡張計画
- 銀行振込やコンビニ決済など追加の決済手段
- 法人向け請求書発行機能
- 複数ユーザーアカウント管理（法人向け）

## 5. セキュリティと運用管理

### 5.1 セキュリティ対策
- カード情報はStripe側で保管（自社サーバーには保存しない）
- 通信経路のTLS暗号化
- Webhook通信の署名検証
- ユーザー認証情報の適切な保護（JWTの署名検証）

### 5.2 運用管理
- Stripeダッシュボードでの決済状況モニタリング
- 失敗した決済の自動リトライと通知
- 定期的な決済データのバックアップ
- 認証セッション管理とセキュリティ監視

### 5.3 ユーザー通知
- 請求前の事前通知（3日前）
- 決済完了・失敗の通知
- 利用量が上限に近づいた際の警告通知（80%到達時）
- LINE Messaging APIを活用した適切な通知

## 6. 法的要件対応

### 6.1 消費税対応
- 適切な税率の自動適用
- Stripeの「Tax Rate」機能を利用

### 6.2 インボイス制度対応
- 適格請求書の自動生成
- 事業者向け登録番号管理
- PDF形式での請求書ダウンロード

### 6.3 利用規約・プライバシーポリシー
- 決済に関する条項の整備
- 個人情報保護法への対応
- キャンセル・返金ポリシーの明確化
- ユーザー認証情報の取り扱いに関する明記
